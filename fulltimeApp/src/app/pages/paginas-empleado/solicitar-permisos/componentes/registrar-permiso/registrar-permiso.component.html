<app-close-modal titleModal="Solicitud Permiso" [formRegistro]="formRegistro" [resetF]="true"></app-close-modal>

<ion-content mode="md">
  <br>
  <app-refresh-info (onRefresh)="ngOnInit()" removeItem="cg_tipo_permiso"></app-refresh-info>

  <form #formRegistro="ngForm" [hidden] = "ocultar">

    <ion-grid>
      <ion-row>
        <ion-col size="6">
          <ion-item style=" font-size: 85%;">
            <ion-icon slot="start" name="document-text-outline"></ion-icon>
            <ion-label>
              <b>Soli.. N°: </b> {{ num_permiso }}
            </ion-label>
          </ion-item>
        </ion-col>
        <ion-col size="6">
          <ion-item style=" font-size: 85%;">
            <ion-label *ngIf="reg.estado == 1">
              <b> Estado: </b> <b style="font-size: 95%; float:right;" class="pendiente"> Pendiente </b>
            </ion-label>
            <ion-label *ngIf="reg.estado != 1">
              <b> Estado: </b> <b style=" font-size: 95%;">{{ reg.estado | estadoSolicitudes }}</b>
            </ion-label>
          </ion-item>
        </ion-col>
      </ion-row>
    </ion-grid>

    <ng-container *ngIf="legalizado == 'SI'">
      <div style="text-align: center;">
        <ion-text id="text_info"> El permiso legalizado depende del tipo de 'permiso seleccionado' </ion-text>
      </div>

      <div class="formdiv">
          <ion-item style=" font-size: 90%;" class="item_fondo">
            <ion-label>
              <b> Permiso Legalizar:  </b> <b style="float:right;"> {{ legalizado }}</b>
            </ion-label>
          </ion-item>
      </div>

      <div style="text-align: center; margin: -1% 0% 4% 0%;">
        <ion-text *ngIf="legalizado == 'SI'" style="font-size: 70%;" > Recuerde despues de enviar la solicitud legalizar el permiso </ion-text>
      </div>
    </ng-container>

    <div style="text-align: center;">
      <ion-text class="is-required" id="text_info">OBLIGATORIO LLENAR LOS CAMPOS CON </ion-text>
    </div>

    <ion-text class="text_info"> Seleccione una opcion </ion-text>
    <div class="formdiv">
      <ion-item class="item_fondo" mode="md">
        <ion-label class="is-required" position="floating"><b> Tipo de Permiso </b> </ion-label>
        <ion-select name="id_tipo_permiso" mode="ios" interface="popover" [(ngModel)]="reg.id_tipo_permiso" (ionChange)="ChangeTipoPermiso($event)">
          <ion-select-option *ngFor="let cg_permiso of cg_tipo_permisos" [value]="cg_permiso.id"> {{ cg_permiso.descripcion }} </ion-select-option>
        </ion-select>
      </ion-item>    
    </div>

    <ng-container *ngIf="reg.id_tipo_permiso != null">
      <div class="formdiv" style="margin-top: 3%;">
        <ion-item class="item_fondo" mode="md">
          <ion-label class="is-required" position="floating"><b>Tiempo del Permiso</b></ion-label>
          <ion-select name="solicitud" mode="ios" interface="popover" [(ngModel)]="selectItemDiasHoras" (ionChange)="ChangeDiasHoras($event)">
            <ion-select-option *ngFor="let dh of diasHoras" [value]="dh.value"> {{ dh.label }} </ion-select-option>
          </ion-select>
        </ion-item>  
      </div>

      <ng-container *ngIf="selectItemDiasHoras != null">
        <ion-text class="text_info" >Ingrese los datos</ion-text>
        <ng-container *ngIf="selectItemDiasHoras != null ">
          <br>
          <div style="text-align: center; width: 100%;">
            <ion-text class="text_info">Ingrese los dias dentro de su calendario laboral </ion-text>
          </div>
          <!-- FECHA INICIO Y FINAL -->
          <ion-grid style="margin-top: -1%;" mode="md">
            <ion-row>
              <ion-col size="6" >
                <div class="formdiv_tiempo">
                  <ion-item class="item_fondo" id="open-regiPermiFechaIni" mode="md">
                    <ion-label class="is-required" position="floating" >Día Inicio</ion-label>
                    <ion-input readonly="true" name="fec_inicio" [ngModel]="dia_inicio" mode="md"></ion-input>
                  </ion-item>
                  <ion-modal trigger="open-regiPermiFechaIni" class="inputDateFecha">
                    <ng-template>
                      <ion-content>
                        <ion-datetime 
                        #datetimeInicio
                        presentation="date"
                        [showDefaultButtons]="false" 
                        size = "fixed"
                        name="fec_inicio" 
                        color="success" 
                        mode="md" 
                        min="1990-01-01" max="2050-12-31" 
                        (ionChange)="ChangeDiaInicio($event)"
                        [value]="reg.fec_inicio"
                        required></ion-datetime>
                        <div style="width: 95%;">
                          <ion-label style="float:right; margin: 2%; font-size: medium;" color="success" (click)="datetimeInicio.cancel(true)">Cancelar</ion-label>
                        </div>
                      </ion-content>
                    </ng-template>
                  </ion-modal>
                </div>
              </ion-col>

              <ion-col size="6">
                <div class="formdiv_tiempo">
                  <ion-item class="item_fondo" id="open-regiPermiFechaFin" mode="md">
                    <ion-label class="is-required" position="floating" >Día Final</ion-label>
                    <ion-input readonly="true" name="fec_final" [ngModel]="dia_fianl" mode="md"></ion-input>
                  </ion-item> 
                  <ion-modal trigger="open-regiPermiFechaFin" *ngIf="(dia_inicio != '') && (selectItemDiasHoras === 'Días')" class="inputDateFecha">
                      <ng-template>
                        <ion-content>
                          <ion-datetime *ngIf="dia_inicio != ''"
                          #datetimeFinal
                          [disabled] = "readonly" 
                          presentation="date"
                          [showDefaultButtons]="false" 
                          size = "fixed"
                          name="fec_final" 
                          mode="md" 
                          [min]="dia_inicio" max="2050-12-31" 
                          (ionChange)="ChangeDiaFinal($event)"
                          [value]="reg.fec_final" 
                          required></ion-datetime>
                          <div style="width: 95%;">
                            <ion-label style="float:right; margin: 2%; font-size: medium;" color="primary" (click)="datetimeFinal.cancel(true)">Cancelar</ion-label>
                          </div>
                        </ion-content>
                      </ng-template>
                  </ion-modal>
                  <ion-popover *ngIf="(dia_inicio == '')" trigger="open-regiPermiFechaFin">
                    <ion-content>
                      <ng-template>
                        <p style="margin: auto; padding: 4%;" >Ingrese la fecha de Inicio</p>
                      </ng-template>
                    </ion-content>
                  </ion-popover>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ng-container>

        <ng-container *ngIf="selectItemDiasHoras == 'Horas' ||  selectItemDiasHoras == 'Días y Horas'">
          <!-- HORA INICIO Y HORA FINAL -->
          <ion-grid style="margin-top: -2%;" mode="md">
            <ion-row>
              <ion-col size="6">
                <div class="formdiv_tiempo">
                  <ion-item class="item_fondo" id="open-regiPermiHoraIni" mode="md">
                    <ion-label class="is-required" position="floating" >Hora Inicio</ion-label>
                    <ion-input readonly="true" name="hora_inicio" [ngModel]="hora_inicio" mode="md"></ion-input>
                  </ion-item>
                  <ion-popover trigger="open-regiPermiHoraIni">
                    <ng-template>
                      <p style="margin: auto; padding: 4%;" *ngIf="(dia_fianl == '') && (reg.fec_final == null)">Ingrese las fechas</p>
                      <ion-datetime *ngIf="dia_fianl != ''"
                        [disabled] = "fech_bloqu" 
                        presentation="time" 
                        mode="md" 
                        name="hora_inicio" 
                        [showDefaultButtons]="true" 
                          doneText="OK"
                          cancelText="Cancelar"
                        hourCycle="h12" 
                        (ionChange)="ChangeHoraInicio($event)" 
                        [value]="reg.hora_salida" 
                        required></ion-datetime>
                    </ng-template>
                  </ion-popover>
                </div>
              </ion-col>
              <ion-col size="6">
                <div class="formdiv_tiempo">
                  <ion-item class="item_fondo" id="open-regiPermiHoraFin" mode="md">
                    <ion-label class="is-required" position="floating" >Hora Final</ion-label>
                    <ion-input readonly="true" name="hora_final" [ngModel]="hora_final" mode="md"></ion-input>
                  </ion-item>
                  <ion-popover trigger="open-regiPermiHoraFin">
                    <ng-template>
                      <p style="margin: auto; padding: 4%;" *ngIf="(hora_inicio == '') && (reg.hora_salida == null)">Ingrese la hora inicio</p>
                      <ion-datetime *ngIf="hora_inicio != ''"
                        [disabled] = "fech_bloquf" 
                        presentation="time" 
                        mode="md" 
                        name="hora_final" 
                        [showDefaultButtons]="true" 
                          doneText="OK"
                          cancelText="Cancelar"
                        hourCycle="h12" 
                        (ionChange)="ChangeHoraFinal($event)" 
                        [value]="reg.hora_ingreso" 
                        required></ion-datetime>
                    </ng-template>
                  </ion-popover>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ng-container>

        <!-- CALCULO DE TIEMPOS -->
        <div *ngIf="selectItemDiasHoras === 'Días'" >
          <ion-button  [disabled]="(btnOculto == true) || (validar.vacio(reg.fec_inicio) ||  validar.vacio(reg.fec_final))" 
            shape="round" expand="block" color="tertiary" (click)="mostrarCalculos()" style="margin: 0% 3% 2% 3%;">
            <ion-icon slot="start" name="calculator-outline"></ion-icon>
            Calcular tiempo real
          </ion-button>
        </div>  
        <div *ngIf="selectItemDiasHoras != 'Días'">
          <ion-button  [disabled]="(btnOculto == true) || (validar.vacio(reg.fec_inicio) || validar.vacio(reg.hora_salida) ||  validar.vacio(reg.fec_final) || validar.vacio(reg.hora_ingreso)) && (btnOculto == false)"
            shape="round" expand="block" color="tertiary" (click)="mostrarCalculos()" style="margin: 0% 3% 2% 3%;">
            <ion-icon slot="start" name="calculator-outline"></ion-icon>
            Calcular tiempo real
          </ion-button>
        </div> 
        
        <ion-text class="text_info">Resultado del calculo</ion-text>
          <!-- CAMPOS DE REFERENCIA A DIAS Y HORAS DE LOS PERMISOS -->
          <ion-list [ngSwitch]="selectItemDiasHoras" style="background-color:transparent; margin-top: -2%">
            <ion-grid *ngSwitchCase="'Días'" mode="md">
              <ion-row>
                <ion-col size="6">
                  <div class="formdiv_tiempo">
                    <ion-item class="item_fondo" mode="md">
                      <ion-label class="is-required" position="floating"><b>Días Permiso</b></ion-label>
                      <ion-input name="dia" [ngModel]="reg.dia" mode="md" maxlengt="10" disabled="true" required></ion-input>
                    </ion-item>
                  </div>
                </ion-col>

                <ion-col size="6">
                  <div class="formdiv_tiempo">
                    <ion-item class="item_fondo" mode="md">
                      <ion-label class="is-required" position="floating"><b>Días Libre</b></ion-label>
                      <ion-input name="dia_libre" [ngModel]="reg.dia_libre" disabled="true" mode="md" maxlengt="10" required></ion-input>
                    </ion-item>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>

          <ion-grid *ngSwitchCase="'Horas'" mode="md">
            <ion-row>
              <ion-col size="12">
                <div class="formdiv_tiempo">
                  <ion-item class="item_fondo" mode="md">
                    <ion-label class="is-required" position="floating"><b>Horas y minutos de permiso</b></ion-label>
                   <ion-input name="hora_numero" displayFormat="HH:mm:ss" disabled="true" [ngModel]="reg.hora_numero" required></ion-input>
                  </ion-item>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-list>

        <ng-container *ngIf="reg.dia !== null  || reg.hora_numero !== null ">
          <ion-text class="text_info">Escriba la razon de la solicitud maximo 55 palabras</ion-text>
          <div class="formdiv">
            <ion-item class="item_fondo" mode="md">
              <ion-label position="floating"> Observación </ion-label>
              <ion-textarea name="descripcion" [(ngModel)]="reg.descripcion" rows="2" cols="20" mode="md" minlength="3" maxlengt="55"></ion-textarea>
            </ion-item>
          </div>
      
          <ion-text class="text_info">Subir documento de respaldo</ion-text>
          <div class="formdiv" >
            <ion-item class="item_fondo" for="file" mode="md">
              <ion-label style="margin: 3% 0% -1.5% 0%; font-size: 75%;" class="is-required"> Justificar Permiso </ion-label>
              
              <!--Este input, permite validar el boton btn_save, que se active o este desactivado deacurdo al documento ingresado-->
              <ion-input [(ngModel)]="reg.docu_nombre" name="file" id="file" [required]="required"></ion-input> 
  
              <!-- Esto, permite ingresar el documento-->
              <ion-label  position="floating" style="font-size: 90%; margin-bottom: 3%;"> 
                <ion-icon slot="start" color="theme" class="icon_upload" name="cloud-upload-outline"></ion-icon>&nbsp; &nbsp; 
                &nbsp;&nbsp; Subir archivo /max 2Mb: 
              </ion-label> 
              <ion-input reandoly="true" type="file" (change)="fileChange($event)" id="file" [required]="required"></ion-input>
  
              <!-- Mesaje que tiene el nombre del archivo a subir -->
              <ion-text *ngIf="reg.docu_nombre != '' " style="font-size: 82%; margin:2% 0% 3% 0%; " color="tertiary">{{reg.docu_nombre}}</ion-text>   
          
              <!-- Mesaje que indica el error en subir el archivo -->
              <ion-text *ngIf="reg.docu_nombre == '' " style="font-size: 82%;  margin:2% 0% 3% 0%;" color="danger">{{mensajeFile}}</ion-text>    
           
            </ion-item>
  
            <div *ngIf="reg.docu_nombre != '' && reg.docu_nombre !== null && reg.docu_nombre !== undefined  && reg.id_tipo_permiso === 2" >
              <ion-button color="medium" shape="round" expand="block"  (click)="deleteDocumentoPermiso()">
                <ion-text style="font-size: 90%;"> <ion-icon color="danger" name="trash-outline"></ion-icon> Quitar documento </ion-text>
              </ion-button>
            </div>
          </div>
  
          <div style="margin: 6% 3% 0% 3%;" [hidden] = "btnOcultoguardar">
            <ion-text *ngIf="cg_permiso.documento === true " color="medium" class="text_info" style="margin: 0% 10% 0% 10%;">
              Es obligatorio en {{cg_permiso.descripcion}} el documento de Respaldo 
            </ion-text>
            <!-- BOTON GUARDAR DESDE OTRO COMPONENTE -->
            <btn-save (onSave)="SaveRegister()" [loadingBtn]="loadingBtn" [formRegistro]="formRegistro"></btn-save>
          </div>

        </ng-container>

      </ng-container>
    </ng-container>
  </form>
  <br>
  
  <div [hidden] = "mensaje">
    <div style="margin: 2%; padding: 2%; text-align: center; border-radius: 2%;">
      <ion-text color='medium' style="font-family: Arial, Helvetica, sans-serif; font-size: 90%;">
        No tiene registrado el periodo de vacaciones para realizar una solicitud
      </ion-text>
    </div>
    <div class="Imagen">
      <span class="centerlogo">
        <img src="../../../assets/images/C_FTLOGORV.png">
        <ion-label style="text-align:center" mode="md" color="medium">  
          <h1 style="font-size: 3vw"><b>Reloj Virtual</b></h1>
        </ion-label>
      </span>
      <br>
      <img style="margin-left: 10%;" src="../../../assets/images/permiso.png"/>
      <br><br>
    </div>
  </div>

  <br>
</ion-content>